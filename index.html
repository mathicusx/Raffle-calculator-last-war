<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Last War Raffle Points Calculator</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }

      .input-section {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
      }

      .list-input {
        flex: 1;
        border: 2px solid #ddd;
        border-radius: 10px;
        padding: 20px;
      }

      .list-input h3 {
        color: #007bff;
        margin-bottom: 15px;
      }

      .list-input textarea {
        width: 100%;
        height: 400px;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px;
        font-family: monospace;
        font-size: 14px;
        resize: vertical;
      }

      .help-text {
        font-size: 12px;
        color: #666;
        margin-top: 10px;
        line-height: 1.4;
      }

      .position-selector {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .position-label {
        min-width: 40px;
        font-weight: bold;
        color: #007bff;
      }

      .name-search {
        position: relative;
        flex: 1;
      }

      .name-input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
      }

      .dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }

      .dropdown-item {
        padding: 8px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }

      .dropdown-item:hover,
      .dropdown-item.highlighted {
        background-color: #f0f0f0;
      }

      .dropdown-item.highlighted {
        background-color: #007bff;
        color: white;
      }

      .dropdown-item:last-child {
        border-bottom: none;
      }

      .name-manager {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #ddd;
      }

      .name-manager h4 {
        margin-bottom: 10px;
        color: #333;
      }

      .name-list {
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
      }

      .name-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 5px;
        border-bottom: 1px solid #eee;
      }

      .name-item:last-child {
        border-bottom: none;
      }

      .remove-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 2px 6px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
      }

      .remove-btn:hover {
        background: #c82333;
      }

      .add-name-section {
        margin-top: 10px;
        display: flex;
        gap: 10px;
      }

      .add-name-input {
        flex: 1;
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      .add-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
      }

      .add-btn:hover {
        background: #218838;
      }

      .btn {
        background-color: #007bff;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
      }

      .btn:hover {
        background-color: #0056b3;
      }

      .btn-clear {
        background-color: #6c757d;
      }

      .btn-clear:hover {
        background-color: #545b62;
      }

      .controls {
        text-align: center;
        margin: 20px 0;
      }

      .results {
        margin-top: 30px;
      }

      .results h3 {
        color: #28a745;
        margin-bottom: 20px;
      }

      .results-table {
        width: 100%;
        border-collapse: collapse;
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
      }

      .results-table th,
      .results-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      .results-table th {
        background-color: #007bff;
        color: white;
        font-weight: bold;
      }

      .results-table tr:hover {
        background-color: #e9ecef;
      }

      .rank-1 {
        background-color: #ffd700 !important;
      }
      .rank-2 {
        background-color: #c0c0c0 !important;
      }
      .rank-3 {
        background-color: #cd7f32 !important;
      }

      .points-breakdown {
        font-size: 12px;
        color: #666;
      }

      .summary {
        margin-top: 20px;
        padding: 15px;
        background-color: #e7f3ff;
        border-radius: 5px;
        border-left: 4px solid #007bff;
      }

      .wheel-section {
        margin-top: 30px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 10px;
        text-align: center;
        display: none;
      }

      .wheel-container {
        position: relative;
        display: inline-block;
        margin: 20px 0;
      }

      .wheel {
        width: 400px;
        height: 400px;
        border-radius: 50%;
        border: 8px solid #333;
        position: relative;
        transition: transform 4s cubic-bezier(0.23, 1, 0.32, 1);
        background: conic-gradient(
          from 0deg,
          #ff6b6b 0deg,
          #4ecdc4 45deg,
          #45b7d1 90deg,
          #96ceb4 135deg,
          #feca57 180deg,
          #ff9ff3 225deg,
          #54a0ff 270deg,
          #5f27cd 315deg
        );
      }

      .wheel-pointer {
        position: absolute;
        top: -15px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 15px solid transparent;
        border-right: 15px solid transparent;
        border-top: 30px solid #333;
        z-index: 10;
      }

      .wheel-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        pointer-events: none;
        z-index: 5;
      }

      .wheel-label {
        position: absolute;
        color: white;
        font-weight: bold;
        font-size: 12px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        pointer-events: none;
        transform-origin: center;
        z-index: 6;
        white-space: nowrap;
      }

      .spin-btn {
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        font-weight: bold;
        border-radius: 25px;
        cursor: pointer;
        margin: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .spin-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      .spin-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .winner-announcement {
        margin: 20px 0;
        padding: 20px;
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        border-radius: 10px;
        border: 3px solid #ff6b6b;
        display: none;
      }

      .winner-text {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
      }

      .winner-points {
        font-size: 16px;
        color: #666;
      }

      .winners-history {
        margin-top: 20px;
        text-align: left;
      }

      .winner-item {
        padding: 10px;
        margin: 5px 0;
        background: white;
        border-radius: 5px;
        border-left: 4px solid #ffd700;
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .container {
          padding: 20px;
        }

        h1 {
          font-size: 1.8rem;
          margin-bottom: 20px;
        }

        .input-section {
          flex-direction: column;
          gap: 15px;
        }

        .list-input {
          padding: 15px;
        }

        .list-input textarea {
          height: 250px;
          font-size: 16px;
        }

        table {
          font-size: 14px;
        }

        th,
        td {
          padding: 8px 4px;
        }

        .spin-btn {
          padding: 12px 25px;
          font-size: 16px;
          margin: 8px;
        }

        .winner-announcement {
          margin: 15px 0;
          padding: 15px;
        }

        .winner-text {
          font-size: 1.5rem;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 15px;
          margin: 10px;
        }

        h1 {
          font-size: 1.5rem;
        }

        .list-input textarea {
          height: 200px;
        }

        table {
          font-size: 12px;
        }

        th,
        td {
          padding: 6px 2px;
        }

        .spin-btn {
          padding: 10px 20px;
          font-size: 14px;
          width: 90%;
          max-width: 300px;
        }

        .probability-bar {
          margin: 4px 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üèÜ Last War Raffle Points Calculator</h1>

      <div class="input-section">
        <div class="list-input">
          <h3>Donation Rankings</h3>
          <div id="donationPositions"></div>
          <div class="help-text">
            Select players for each ranking position.<br />
            Order matters: 1st name = 20 points, 2nd name = 19 points, etc.
          </div>
          <button class="btn btn-clear" onclick="clearPositions('donation')">
            Clear All
          </button>
        </div>

        <div class="list-input">
          <h3>VS Rankings</h3>
          <div id="vsPositions"></div>
          <div class="help-text">
            Select players for each ranking position.<br />
            Special scoring: 1st name = 30 points, 2nd name = 25 points, 3rd
            name = 22 points, then 4th name = 17 points, etc.
          </div>
          <button class="btn btn-clear" onclick="clearPositions('vs')">
            Clear All
          </button>
        </div>
      </div>

      <div class="name-manager">
        <h4>üîß Manage Player Names</h4>
        <div class="add-name-section">
          <input
            type="text"
            class="add-name-input"
            id="newPlayerName"
            placeholder="Add new player name..."
          />
          <button class="add-btn" onclick="addPlayerName()">Add</button>
          <button class="btn btn-clear" onclick="resetToDefaults()">
            Reset to Defaults
          </button>
        </div>
        <div class="name-list" id="playerNamesList"></div>
      </div>

      <div class="controls">
        <button class="btn" onclick="calculateRafflePoints()">
          Calculate Combined Points
        </button>
        <button class="btn btn-clear" onclick="clearAll()">Clear All</button>
        <button class="btn btn-clear" onclick="loadExample()">
          Load Example
        </button>
      </div>

      <div class="results" id="results" style="display: none">
        <h3>Combined Raffle Points Results</h3>
        <table class="results-table">
          <thead>
            <tr>
              <th>Final Rank</th>
              <th>Player Name</th>
              <th>Total Points</th>
              <th>Points Breakdown</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>

        <div class="summary" id="summary"></div>
      </div>
    </div>

    <script>
      // Default player names (100 names)
      const DEFAULT_PLAYER_NAMES = [
        "SophieCode",
        "Mathicusx",
        "Coldenn",
        "MuziK",
        "BaileyR123",
        "Spada92i",
        "Rosieeee22",
        "Liiisaa",
        "ON MY WAY",
        "iMez",
        "Tadbo",
        "The Swedeon",
        "Lado996",
        "Luizajra",
        "Hapkolor",
        "Simba",
        "Puzatoil",
        "DABA2A",
        "Andrez08",
        "Ted SG",
        "Auromoon",
        "Hiahan",
        "hackydd",
        "Lan4ik",
        "Hanna a",
        "Or3lha5",
        "Viki",
        "Crushomar",
        "LupoSolitorio90",
        "Mrvson",
        "–ö–∞—Ç—è –í",
        "PetitPonaay",
        "Oski200",
        "rBaun",
        "ogeg",
        "GanagaV",
        "CarlosGaemz",
        "–ê–ª—ä–†–∞—Ö—à",
        "Lenny",
        "Terminator279",
        "Lethal66",
        "BullyDattel",
        "xqmpx",
        "Manon 25",
        "RubenMM",
        "Vsd1anj",
        "–¥–∂–µ–∫—Å",
        "METEORITE",
        "WeidEsq",
        "Who This",
        "Unknown",
        "–ü–∞–≤—É–∫12",
        "TheCSL",
        "Helenscorpio",
        "Amon1181",
        "YasyA",
        "InfinityLudka",
        "Coldfatjam",
        "Torbs",
        "wess1122",
        "wohoooooo",
        "DarryM",
        "Magic Panda",
        "Scottea",
        "LionShrimp",
        "Brus Milton",
        "Hnclubaogiac",
        "Gafir07",
        "Djibzzzz",
        "Aggelos25",
        "likmus93",
        "Dyna UwU",
        "LeonaHa",
        "mat8rello",
        "Barak1997",
        "ANTHROPUS",
        "ShadowTheSoul",
        "Hakuna Matata",
        "Tygermen",
        "Rick Sanchez",
        "Toddy2002",
        "DonnerKrieger",
        "Black",
        "Yasko",
        "Bankai",
        "bubba2025",
        "jaxon7z",
        "Ivan 777",
        "Ori36",
        "Max030303",
        "mafuch",
        
      ];

      let donationPositions = [];
      let vsPositions = [];

      // Initialize localStorage and UI on page load
      document.addEventListener("DOMContentLoaded", function () {
        initializePlayerNames();
        updatePlayerNamesList();
        initializePositions();
      });

      function initializePlayerNames() {
        const storedNames = localStorage.getItem("playerNames");
        if (!storedNames) {
          localStorage.setItem(
            "playerNames",
            JSON.stringify(DEFAULT_PLAYER_NAMES)
          );
        }
      }

      function getPlayerNames() {
        const names = localStorage.getItem("playerNames");
        return names ? JSON.parse(names) : DEFAULT_PLAYER_NAMES;
      }

      function setPlayerNames(names) {
        localStorage.setItem("playerNames", JSON.stringify(names));
        updatePlayerNamesList();
      }

      function addPlayerName() {
        const newName = document.getElementById("newPlayerName").value.trim();
        if (!newName) return;

        const names = getPlayerNames();
        if (!names.includes(newName)) {
          names.push(newName);
          setPlayerNames(names);
          document.getElementById("newPlayerName").value = "";
        } else {
          alert("Player name already exists!");
        }
      }

      function removePlayerName(name) {
        const names = getPlayerNames();
        const updatedNames = names.filter((n) => n !== name);
        setPlayerNames(updatedNames);
      }

      function resetToDefaults() {
        if (
          confirm("This will reset all player names to defaults. Continue?")
        ) {
          setPlayerNames([...DEFAULT_PLAYER_NAMES]);
        }
      }

      function updatePlayerNamesList() {
        const names = getPlayerNames();
        const listElement = document.getElementById("playerNamesList");

        listElement.innerHTML = names
          .map(
            (name) => `
                <div class="name-item">
                    <span>${name}</span>
                    <button class="remove-btn" onclick="removePlayerName('${name}')">Remove</button>
                </div>
            `
          )
          .join("");
      }

      function initializePositions() {
        // Create 20 positions for each list by default
        donationPositions = new Array(20).fill("");
        vsPositions = new Array(20).fill("");

        refreshPositions("donation");
        refreshPositions("vs");
      }

      function createPositionElement(listType, positionNumber) {
        const div = document.createElement("div");
        div.className = "position-selector";
        div.innerHTML = `
                <div class="position-label">#${positionNumber}</div>
                <div class="name-search">
                    <input type="text" class="name-input"
                           placeholder="Type to search or select player..."
                           onkeyup="handleKeyUp(event, this, '${listType}', ${
          positionNumber - 1
        })"
                           onkeydown="handleKeyDown(event, this)"
                           onfocus="showDropdown(this)"
                           onblur="hideDropdown(this)">
                    <div class="dropdown"></div>
                </div>
                <button class="remove-btn" onclick="removePosition('${listType}', ${
          positionNumber - 1
        })">Remove</button>
            `;
        return div;
      }

      function removePosition(listType, index) {
        const positions =
          listType === "donation" ? donationPositions : vsPositions;
        const container = document.getElementById(listType + "Positions");

        if (positions.length <= 1) {
          alert("At least one position is required!");
          return;
        }

        positions.splice(index, 1);
        refreshPositions(listType);
      }

      function clearPositions(listType) {
        if (listType === "donation") {
          donationPositions = new Array(20).fill("");
        } else {
          vsPositions = new Array(20).fill("");
        }

        refreshPositions(listType);
      }

      function refreshPositions(listType) {
        const positions =
          listType === "donation" ? donationPositions : vsPositions;
        const container = document.getElementById(listType + "Positions");

        container.innerHTML = "";
        positions.forEach((_, index) => {
          const positionElement = createPositionElement(listType, index + 1);
          container.appendChild(positionElement);

          // Restore the value
          const input = positionElement.querySelector(".name-input");
          input.value = positions[index];
        });
      }

      let currentHighlightIndex = -1;
      let currentActiveDropdown = null;

      function showDropdown(input) {
        const dropdown = input.nextElementSibling;
        currentActiveDropdown = dropdown;
        currentHighlightIndex = -1;
        populateDropdown(dropdown, "");
        dropdown.style.display = "block";
      }

      function hideDropdown(input) {
        setTimeout(() => {
          const dropdown = input.nextElementSibling;
          dropdown.style.display = "none";
          currentActiveDropdown = null;
          currentHighlightIndex = -1;
        }, 200);
      }

      function handleKeyUp(event, input, listType, index) {
        // Don't filter on arrow keys or enter
        if (["ArrowUp", "ArrowDown", "Enter", "Escape"].includes(event.key)) {
          return;
        }

        filterNames(input, listType, index);
      }

      function handleKeyDown(event, input) {
        const dropdown = input.nextElementSibling;
        const items = dropdown.querySelectorAll(".dropdown-item");

        switch (event.key) {
          case "ArrowDown":
            event.preventDefault();
            if (dropdown.style.display === "none") {
              showDropdown(input);
              return;
            }
            currentHighlightIndex = Math.min(
              currentHighlightIndex + 1,
              items.length - 1
            );
            updateHighlight(items);
            break;

          case "ArrowUp":
            event.preventDefault();
            if (dropdown.style.display === "none") {
              showDropdown(input);
              return;
            }
            currentHighlightIndex = Math.max(currentHighlightIndex - 1, -1);
            updateHighlight(items);
            break;

          case "Enter":
            event.preventDefault();
            if (dropdown.style.display !== "none" && items.length > 0) {
              const targetIndex =
                currentHighlightIndex >= 0 ? currentHighlightIndex : 0;
              const targetItem = items[targetIndex];
              if (
                targetItem &&
                !targetItem.textContent.includes("No matches found")
              ) {
                selectNameFromElement(targetItem, input);
              }
            }
            break;

          case "Escape":
            event.preventDefault();
            dropdown.style.display = "none";
            currentActiveDropdown = null;
            currentHighlightIndex = -1;
            break;
        }
      }

      function updateHighlight(items) {
        items.forEach((item, index) => {
          item.classList.toggle("highlighted", index === currentHighlightIndex);
        });
      }

      function filterNames(input, listType, index) {
        const dropdown = input.nextElementSibling;
        const searchTerm = input.value.toLowerCase();

        currentHighlightIndex = -1; // Reset highlight when filtering
        populateDropdown(dropdown, searchTerm);
        dropdown.style.display = "block";

        // Update the position array
        if (listType === "donation") {
          donationPositions[index] = input.value;
        } else {
          vsPositions[index] = input.value;
        }
      }

      function populateDropdown(dropdown, searchTerm) {
        const names = getPlayerNames();
        const filteredNames = names.filter((name) =>
          name.toLowerCase().includes(searchTerm)
        );

        dropdown.innerHTML = filteredNames
          .map(
            (name, index) => `
                <div class="dropdown-item"
                     onmousedown="selectName(this, '${name}')"
                     onmouseenter="highlightItem(this, ${index})">${name}</div>
            `
          )
          .join("");

        if (filteredNames.length === 0) {
          dropdown.innerHTML =
            '<div class="dropdown-item">No matches found</div>';
        }
      }

      function highlightItem(element, index) {
        const dropdown = element.parentElement;
        const items = dropdown.querySelectorAll(".dropdown-item");
        currentHighlightIndex = index;
        updateHighlight(items);
      }

      function selectName(element, name) {
        const input = element
          .closest(".name-search")
          .querySelector(".name-input");
        selectNameFromElement(element, input, name);
      }

      function selectNameFromElement(element, input, name = null) {
        const actualName = name || element.textContent;
        const dropdown = element.closest(".dropdown");

        input.value = actualName;
        dropdown.style.display = "none";
        currentActiveDropdown = null;
        currentHighlightIndex = -1;

        // Update the position array
        const positionSelector = input.closest(".position-selector");
        const container = positionSelector.parentElement;
        const listType = container.id.includes("donation") ? "donation" : "vs";
        const index = Array.from(container.children).indexOf(positionSelector);

        if (listType === "donation") {
          donationPositions[index] = actualName;
        } else {
          vsPositions[index] = actualName;
        }

        // Focus next input if available (but not on mobile to prevent keyboard closing)
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (!isMobile) {
          const nextPosition = container.children[index + 1];
          if (nextPosition) {
            const nextInput = nextPosition.querySelector(".name-input");
            if (nextInput) {
              setTimeout(() => nextInput.focus(), 100);
            }
          }
        }
      }

      function calculateRafflePoints() {
        // Get selected players from position selectors
        const listA = donationPositions.filter((name) => name.trim());
        const listB = vsPositions.filter((name) => name.trim());

        if (listA.length === 0 && listB.length === 0) {
          alert("Please select at least one player in either ranking list.");
          return;
        }

        const playerPoints = {};
        const nameMapping = {};

        function normalizeAndMatch(playerName, existingNames) {
          const normalized = playerName.toLowerCase().trim();

          for (const existingName of existingNames) {
            if (normalized === existingName.toLowerCase().trim()) {
              return existingName;
            }
          }

          return playerName;
        }

        listA.forEach((player, index) => {
          const points = Math.max(1, 21 - (index + 1));
          const existingNames = Object.keys(playerPoints);
          const canonicalName = normalizeAndMatch(player, existingNames);

          if (!playerPoints[canonicalName]) {
            playerPoints[canonicalName] = {
              total: 0,
              breakdown: [],
              originalNames: new Set(),
            };
          }

          playerPoints[canonicalName].total += points;
          playerPoints[canonicalName].breakdown.push(
            `List A: #${index + 1} (${points}pts)`
          );
          playerPoints[canonicalName].originalNames.add(player);
        });

        listB.forEach((player, index) => {
          let points;
          if (index === 0) {
            points = 30; // 1st place
          } else if (index === 1) {
            points = 25; // 2nd place
          } else if (index === 2) {
            points = 22; // 3rd place
          } else {
            points = Math.max(1, 21 - (index + 1)); // 4th place and below use old system
          }
          const existingNames = Object.keys(playerPoints);
          const canonicalName = normalizeAndMatch(player, existingNames);

          if (!playerPoints[canonicalName]) {
            playerPoints[canonicalName] = {
              total: 0,
              breakdown: [],
              originalNames: new Set(),
            };
          }

          playerPoints[canonicalName].total += points;
          playerPoints[canonicalName].breakdown.push(
            `List B: #${index + 1} (${points}pts)`
          );
          playerPoints[canonicalName].originalNames.add(player);
        });

        const sortedResults = Object.entries(playerPoints)
          .map(([name, data]) => ({
            name: name,
            total: data.total,
            breakdown: data.breakdown,
            originalNames: Array.from(data.originalNames),
          }))
          .sort((a, b) => b.total - a.total);

        displayResults(sortedResults, listA.length, listB.length);

        if (sortedResults.length > 0) {
          showRandomizer(sortedResults);
        }
      }

      let rafflePlayers = [];
      let isDrawing = false;
      let drawCount = 0;
      let winners = [];

      function showRandomizer(players) {
        rafflePlayers = [...players];
        drawCount = 0;

        const randomHTML = `
                <div style="margin-top: 30px; padding: clamp(20px, 5vw, 40px); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                    <h2 style="color: white; margin-bottom: 10px; font-size: clamp(1.5rem, 4vw, 2.5rem); text-shadow: 0 2px 4px rgba(0,0,0,0.3);">üé≤ Weighted Random Draw</h2>
                    <p style="color: rgba(255,255,255,0.9); margin-bottom: 30px; font-size: clamp(0.9rem, 2.5vw, 1.1rem);">Higher points = higher chance to win!</p>
                    
                    <div style="max-width: min(500px, 90vw); margin: 0 auto 20px; background: rgba(255,255,255,0.1); border-radius: 12px; padding: clamp(10px, 3vw, 15px);">
                        <h3 style="color: white; margin-bottom: 10px; font-size: clamp(1rem, 2.5vw, 1.1rem);">Win Probabilities</h3>
                        <div id="probabilityBars" style="max-height: 200px; overflow-y: auto;">
                            ${createProbabilityBars(players)}
                        </div>
                    </div>
                    
                    <div style="height: 200px; margin: 30px 0; display: flex; align-items: center; justify-content: center;">
                        <div id="drawAnimation" style="display: none; font-size: 4em;">üé≤</div>
                        <div id="drawResult" style="display: none; text-align: center;">
                            <div id="winnerName" style="font-size: 3em; color: #ffd700; font-weight: bold; margin-bottom: 10px;"></div>
                            <div id="winnerInfo" style="font-size: 1.2em; color: rgba(255,255,255,0.9);"></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                        <button id="drawBtn" onclick="drawWinner()" style="background: linear-gradient(45deg, #ff4757, #ff6b7a); color: white; border: none; padding: clamp(15px, 3vw, 20px) clamp(30px, 6vw, 50px); font-size: clamp(16px, 3vw, 24px); font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 10px 30px rgba(255, 71, 87, 0.4); transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 2px; min-width: 200px;">
                            üéØ DRAW WINNER
                        </button>
                        <button onclick="resetDraw()" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: clamp(12px, 2.5vw, 15px) clamp(20px, 4vw, 30px); border-radius: 50px; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s ease; min-width: 100px;">
                            Reset
                        </button>
                    </div>
                    
                    <div id="winnersHistory" style="margin-top: 30px; display: none;">
                        <div style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; max-width: 600px; margin: 0 auto;">
                            <h3 style="color: white; margin-bottom: 15px; text-align: center;">üèÜ Winners List</h3>
                            <div id="winnersList" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
            `;

        document
          .querySelector(".container")
          .insertAdjacentHTML("beforeend", randomHTML);
      }

      function createProbabilityBars(players) {
        const totalPoints = players.reduce((sum, p) => sum + p.total, 0);
        const colors = [
          "#FF6B6B",
          "#4ECDC4",
          "#45B7D1",
          "#96CEB4",
          "#FECA57",
          "#FF9FF3",
        ];

        return players
          .map((player, index) => {
            const probability = ((player.total / totalPoints) * 100).toFixed(1);
            const color = colors[index % colors.length];

            return `
                    <div style="display: flex; align-items: center; margin: 4px 0; background: rgba(255,255,255,0.1); border-radius: 8px; padding: clamp(6px, 2vw, 8px); font-size: clamp(0.8rem, 2vw, 1rem);">
                        <div style="flex: 1; text-align: left; color: white; font-weight: bold; min-width: clamp(80px, 20vw, 120px); word-break: break-word;">${player.name}</div>
                        <div style="flex: 2; margin: 0 clamp(5px, 2vw, 10px);">
                            <div style="background: rgba(255,255,255,0.2); height: clamp(16px, 3vw, 20px); border-radius: 10px; overflow: hidden;">
                                <div style="height: 100%; background: ${color}; width: ${probability}%; transition: width 0.5s ease; border-radius: 10px;"></div>
                            </div>
                        </div>
                        <div style="min-width: clamp(60px, 15vw, 80px); text-align: right; color: white; font-weight: bold; font-size: clamp(0.7rem, 1.5vw, 0.9rem);">${probability}%</div>
                    </div>
                `;
          })
          .join("");
      }

      function weightedRandomSelect(players) {
        const totalWeight = players.reduce(
          (sum, player) => sum + player.total,
          0
        );
        let random = Math.random() * totalWeight;

        for (const player of players) {
          random -= player.total;
          if (random <= 0) {
            return player;
          }
        }

        return players[0];
      }

      function drawWinner() {
        if (isDrawing || !rafflePlayers || rafflePlayers.length === 0) {
          return;
        }

        isDrawing = true;
        const drawBtn = document.getElementById("drawBtn");
        const drawAnimation = document.getElementById("drawAnimation");
        const drawResult = document.getElementById("drawResult");

        if (!drawBtn || !drawAnimation || !drawResult) {
          isDrawing = false;
          return;
        }

        drawBtn.disabled = true;

        drawResult.style.display = "none";
        drawAnimation.style.display = "block";

        let animationCount = 0;
        const animateInterval = setInterval(() => {
          const animations = ["üé≤", "üé∞", "üÉè", "üéØ"];
          drawAnimation.textContent =
            animations[animationCount % animations.length];
          animationCount++;
        }, 200);

        setTimeout(() => {
          try {
            clearInterval(animateInterval);
            const winner = weightedRandomSelect(rafflePlayers);
            showWinner(winner);
          } catch (error) {
            drawAnimation.textContent = "‚ùå Error";
          }

          isDrawing = false;
          drawBtn.disabled = false;
        }, 2000);
      }

      function showWinner(winner) {
        drawCount++;

        winners.push({
          name: winner.name,
          points: winner.total,
          drawNumber: drawCount,
          winChance:
            rafflePlayers.length > 0
              ? (
                  (winner.total /
                    (rafflePlayers.reduce((sum, p) => sum + p.total, 0) +
                      winner.total)) *
                  100
                ).toFixed(1)
              : "100.0",
        });

        document.getElementById("drawAnimation").style.display = "none";
        document.getElementById("drawResult").style.display = "block";
        document.getElementById("winnerName").textContent = `üèÜ ${winner.name}`;

        const totalBefore =
          rafflePlayers.length > 0
            ? rafflePlayers.reduce((sum, p) => sum + p.total, 0) + winner.total
            : winner.total;
        const winChance = ((winner.total / totalBefore) * 100).toFixed(1);
        document.getElementById(
          "winnerInfo"
        ).textContent = `${winner.total} points ‚Ä¢ ${winChance}% chance ‚Ä¢ Draw #${drawCount}`;

        rafflePlayers = rafflePlayers.filter((p) => p.name !== winner.name);

        updateProbabilityBars();

        updateWinnersHistory();

        if (rafflePlayers.length === 0) {
          document.getElementById("drawBtn").textContent = "üéâ All Done!";
          document.getElementById("drawBtn").disabled = true;
        } else {
          document.getElementById("drawBtn").textContent = `üéØ Draw #${
            drawCount + 1
          }`;
        }
      }

      function updateProbabilityBars() {
        if (rafflePlayers.length === 0) {
          document.getElementById("probabilityBars").innerHTML =
            '<div style="color: white; font-style: italic; text-align: center; padding: 20px;">All players have been drawn!</div>';
          return;
        }

        const totalPoints = rafflePlayers.reduce((sum, p) => sum + p.total, 0);
        const colors = [
          "#FF6B6B",
          "#4ECDC4",
          "#45B7D1",
          "#96CEB4",
          "#FECA57",
          "#FF9FF3",
        ];

        document.getElementById("probabilityBars").innerHTML = rafflePlayers
          .map((player, index) => {
            const probability = ((player.total / totalPoints) * 100).toFixed(1);
            const color = colors[index % colors.length];

            return `
                    <div style="display: flex; align-items: center; margin: 4px 0; background: rgba(255,255,255,0.1); border-radius: 8px; padding: clamp(6px, 2vw, 8px); font-size: clamp(0.8rem, 2vw, 1rem);">
                        <div style="flex: 1; text-align: left; color: white; font-weight: bold; min-width: clamp(80px, 20vw, 120px); word-break: break-word;">${player.name}</div>
                        <div style="flex: 2; margin: 0 clamp(5px, 2vw, 10px);">
                            <div style="background: rgba(255,255,255,0.2); height: clamp(16px, 3vw, 20px); border-radius: 10px; overflow: hidden;">
                                <div style="height: 100%; background: ${color}; width: ${probability}%; transition: width 0.5s ease; border-radius: 10px;"></div>
                            </div>
                        </div>
                        <div style="min-width: clamp(60px, 15vw, 80px); text-align: right; color: white; font-weight: bold; font-size: clamp(0.7rem, 1.5vw, 0.9rem);">${probability}%</div>
                    </div>
                `;
          })
          .join("");
      }

      function updateWinnersHistory() {
        if (winners.length === 0) {
          document.getElementById("winnersHistory").style.display = "none";
          return;
        }

        document.getElementById("winnersHistory").style.display = "block";

        document.getElementById("winnersList").innerHTML = winners
          .map(
            (winner) => `
                <div style="display: flex; align-items: center; margin: 6px 0; background: rgba(255,215,0,0.2); border-radius: 10px; padding: clamp(8px, 2vw, 12px); border: 2px solid #FFD700; font-size: clamp(0.85rem, 2vw, 1rem);">
                    <div style="flex: 0 0 clamp(30px, 8vw, 40px); text-align: center; color: #FFD700; font-weight: bold; font-size: clamp(1rem, 3vw, 1.2rem);">#${winner.drawNumber}</div>
                    <div style="flex: 1; text-align: left; color: white; font-weight: bold; margin-left: clamp(10px, 2vw, 15px); word-break: break-word;">${winner.name}</div>
                    <div style="min-width: clamp(90px, 20vw, 120px); text-align: right; color: white; font-weight: bold; font-size: clamp(0.75rem, 1.8vw, 0.9rem);">${winner.points} pts (${winner.winChance}%)</div>
                </div>
            `
          )
          .join("");
      }

      function resetDraw() {
        calculateRafflePoints();
        winners = [];
        updateWinnersHistory();
      }

      function getSimilarity(str1, str2) {
        const longer = str1.length > str2.length ? str1 : str2;
        const shorter = str1.length > str2.length ? str2 : str1;

        if (longer.length === 0) return 1.0;

        const editDistance = getEditDistance(longer, shorter);
        return (longer.length - editDistance) / longer.length;
      }

      function getEditDistance(str1, str2) {
        const matrix = Array(str2.length + 1)
          .fill(null)
          .map(() => Array(str1.length + 1).fill(null));

        for (let i = 0; i <= str1.length; i++) matrix[0][i] = i;
        for (let j = 0; j <= str2.length; j++) matrix[j][0] = j;

        for (let j = 1; j <= str2.length; j++) {
          for (let i = 1; i <= str1.length; i++) {
            const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
            matrix[j][i] = Math.min(
              matrix[j][i - 1] + 1,
              matrix[j - 1][i] + 1,
              matrix[j - 1][i - 1] + cost
            );
          }
        }

        return matrix[str2.length][str1.length];
      }

      function displayResults(results, listACount, listBCount) {
        const resultsDiv = document.getElementById("results");
        const resultsBody = document.getElementById("resultsBody");
        const summary = document.getElementById("summary");

        resultsBody.innerHTML = "";

        results.forEach((player, index) => {
          const row = resultsBody.insertRow();

          if (index === 0) row.classList.add("rank-1");
          else if (index === 1) row.classList.add("rank-2");
          else if (index === 2) row.classList.add("rank-3");

          row.insertCell(0).textContent = `#${index + 1}`;

          const nameCell = row.insertCell(1);
          if (player.originalNames && player.originalNames.length > 1) {
            nameCell.innerHTML = `<strong>${
              player.name
            }</strong><br><small style="color: #666;">Also: ${player.originalNames
              .filter((n) => n !== player.name)
              .join(", ")}</small>`;
          } else {
            nameCell.textContent = player.name;
          }

          row.insertCell(2).textContent = `${player.total} points`;

          const breakdownCell = row.insertCell(3);
          breakdownCell.innerHTML = player.breakdown.join("<br>");
          breakdownCell.classList.add("points-breakdown");
        });

        // Summary
        const totalPlayers = results.length;
        const duplicatePlayers = results.filter(
          (p) => p.breakdown.length > 1
        ).length;
        const mergedPlayers = results.filter(
          (p) => p.originalNames && p.originalNames.length > 1
        ).length;

        summary.innerHTML = `
                <strong>Summary:</strong><br>
                ‚Ä¢ List A: ${listACount} players<br>
                ‚Ä¢ List B: ${listBCount} players<br>
                ‚Ä¢ Total unique players: ${totalPlayers}<br>
                ‚Ä¢ Players in both lists: ${duplicatePlayers}<br>
                ‚Ä¢ Names merged due to similarity: ${mergedPlayers}<br>
                ‚Ä¢ Winner: <strong>${results[0]?.name || "N/A"}</strong> with ${
          results[0]?.total || 0
        } points
            `;

        resultsDiv.style.display = "block";
      }

      function clearAll() {
        clearPositions("donation");
        clearPositions("vs");
        document.getElementById("results").style.display = "none";
      }

      function loadExample() {
        // Clear and set up donation positions
        donationPositions = [
          "ViktorBigC√∂ckeres",
          "iMez",
          "XZero",
          "rBaun",
          "BaileyR123",
          "ON MY WAY",
          "Liiisaa",
          "ShadowTheSoul",
          "Lado996",
          "Hiahan",
        ];
        refreshPositions("donation");

        // Clear and set up VS positions
        vsPositions = [
          "iMez",
          "XZero",
          "ShadowTheSoul",
          "NewPlayer1",
          "NewPlayer2",
          "rBaun",
          "Hiahan",
          "NewPlayer3",
          "BaileyR123",
          "NewPlayer4",
        ];
        refreshPositions("vs");
      }
    </script>
  </body>
</html>
